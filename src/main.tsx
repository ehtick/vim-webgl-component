import * as THREE from 'three'
import * as VIM from 'vim-webgl-viewer/'

import {
  createVimComponent,
  VimComponentRef,
  getLocalSettings
} from './component'

// Parse URL
const params = new URLSearchParams(window.location.search)
// Edge server doesn't serve http ranges properly
const url = params.has('vim')
  ? params.get('vim')
  : 'https://vimdevelopment01storage.blob.core.windows.net/samples/TowerS-ARCHITECTURE-ALL.v1.2.50.vim'

createVimComponent(loadVim, undefined, getLocalSettings())

async function loadVim (cmp: VimComponentRef) {
  globalThis.component = cmp
  const vim = await cmp.loader.load('residence_nozip.vim', {
    rotation: new THREE.Vector3(270, 0, 0)
  })
  cmp.viewer.add(vim)
}

/*
const instances = [
  10198, 48057, 18053, 21663, 63514, 63482, 66821, 66823, 81572, 22228, 22230,
  22234, 22238, 80531, 22381, 22535, 22539, 22180, 35655, 35701, 22185, 22187,
  22330, 22328, 22341, 22273, 22271, 22293, 22297, 22319, 24638, 24695, 22314,
  38882, 6711, 6744, 83505, 20438, 2104, 2160, 2162, 2165, 2167, 2170, 2172,
  2178, 2180, 2186, 2192, 2195, 2198, 2200, 2203, 2206, 2208, 2210, 2216, 2218,
  2220, 2222, 2225, 2227, 2229, 2231, 2233, 2239, 2245, 2247, 2253, 2261, 2263,
  2265, 2267, 2367, 2370, 2421, 3139, 3150, 3371, 3586, 3604, 3768, 3770, 3773,
  3775, 4700, 4702, 4709, 4711, 4720, 4843, 4938, 5320, 5365, 5471, 5712, 5714,
  5966, 6108, 6110, 6112, 6114, 6122, 6124, 6136, 6141, 6511, 6514, 6528, 6530,
  6532, 6534, 6536, 6538, 6540, 6683, 6703, 6716, 6746, 6779, 6781, 6783, 6785,
  6790, 7042, 7046, 7057, 7059, 7146, 7161, 7163, 7165, 7167, 7708, 7711, 7867,
  7910, 7931, 7936, 8048, 8395, 8403, 8449, 8500, 8506, 8586, 8596, 8602, 8608,
  9671, 9833, 9836, 9878, 9880, 9903, 9906, 9958, 9960, 9964, 9978, 9982, 10173,
  10175, 10202, 10395, 10397, 10401, 10635, 10639, 10643, 10697, 10916, 11753,
  11775, 11777, 11851, 11853, 11859, 12010, 12058, 12135, 12158, 12180, 12182,
  12199, 12204, 12209, 12214, 12220, 12281, 12288, 12299, 12301, 12373, 12377,
  12383, 12539, 12596, 12602, 12608, 12615, 12621, 12679, 12681, 12685, 12688,
  12756, 12785, 12787, 12792, 12794, 12809, 12822, 13240, 13246, 13255, 13261,
  13267, 13278, 13284, 13292, 13298, 13308, 13314, 13324, 13330, 13339, 13345,
  13358, 13364, 13375, 13381, 13392, 13398, 13408, 13414, 13432, 13434, 13442,
  13555, 13927, 13937, 13939, 13996, 14004, 14006, 14008, 15127, 15147, 15164,
  15177, 15184, 15196, 15203, 15368, 15374, 15380, 15386, 16115, 16135, 16171,
  16340, 16347, 16354, 16367, 16378, 16380, 16383, 16391, 16393, 16396, 16519,
  16543, 16551, 16606, 16613, 16619, 16625, 16631, 16637, 16643, 16649, 16655,
  16661, 16667, 16673, 16679, 16685, 16691, 16693, 17086, 17088, 17091, 17130,
  17146, 17175, 17181, 17996, 18044, 18060, 19318, 19320, 19341, 19343, 19349,
  19353, 19396, 19408, 19414, 19420, 19426, 19432, 19438, 19463, 19495, 19505,
  19507, 19510, 19513, 19732, 19738, 19771, 19777, 19788, 19794, 19985, 19991,
  20114, 20137, 20142, 20145, 20248, 20250, 20253, 20255, 20258, 20260, 20263,
  20266, 20291, 20317, 20319, 20322, 20327, 20329, 20331, 20333, 20335, 20337,
  20339, 20348, 20350, 20352, 20362, 20364, 20374, 20381, 20390, 20392, 20394,
  20396, 20398, 20400, 20402, 20405, 20407, 20414, 20420, 20426, 20432, 20440,
  20442, 20449, 20455, 20489, 20666, 20710, 20716, 20722, 20727, 20733, 20735,
  20737, 20740, 20742, 20748, 20750, 20756, 20758, 20764, 20891, 21066, 21072,
  21075, 21083, 21089, 21095, 21101, 21104, 21110, 21117, 21123, 21129, 21143,
  21149, 21422, 21502, 21524, 21531, 21537, 21544, 21551, 21558, 21584, 21609,
  21669, 22131, 22133, 22135, 22137, 22139, 22141, 22143, 22145, 22148, 22151,
  22153, 22155, 22157, 22161, 22163, 22165, 22167, 22170, 22172, 22176, 22182,
  22189, 22191, 22193, 22196, 22198, 22200, 22202, 22204, 22206, 22208, 22210,
  22217, 22226, 22232, 22236, 22240, 22242, 22244, 22246, 22249, 22251, 22253,
  22255, 22257, 22259, 22261, 22263, 22265, 22267, 22269, 22279, 22281, 22283,
  22285, 22287, 22289, 22291, 22295, 22300, 22302, 22304, 22306, 22308, 22310,
  22317, 22321, 22323, 22325, 22332, 22334, 22336, 22338, 22345, 22347, 22349,
  22351, 22353, 22355, 22357, 22359, 22362, 22364, 22366, 22368, 22370, 22372,
  22374, 22376, 22379, 22385, 22387, 22389, 22391, 22393, 22397, 22399, 22522,
  22524, 22526, 22528, 22530, 22532, 22543, 22545, 22547, 22549, 22551, 22555,
  22557, 22559, 22561, 22563, 22567, 22569, 22575, 22595, 22601, 22614, 22659,
  22661, 22663, 22666, 22701, 22749, 22856, 22870, 23111, 23113, 23194, 23196,
  24064, 24070, 24181, 24187, 24193, 24200, 24207, 24697, 24711, 24717, 24719,
  24743, 24745, 24747, 24812, 25773, 25776, 25778, 26975, 27004, 27006, 27008,
  27106, 27154, 27176, 27193, 27195, 27552, 27554, 29064, 29066, 29068, 29070,
  29105, 29141, 29155, 29192, 29224, 29226, 29228, 29230, 29232, 29235, 29347,
  29369, 29371, 29373, 29433, 29455, 29457, 29459, 29572, 29580, 29586, 29588,
  29590, 29926, 29928, 29972, 29974, 29976, 30065, 30077, 30119, 30121, 30620,
  30812, 30901, 30911, 30939, 30977, 30980, 31125, 31161, 31204, 31210, 31276,
  31282, 32220, 32358, 32404, 32416, 32436, 32522, 32568, 32614, 32660, 32706,
  32752, 33030, 33040, 33229, 33645, 33695, 33748, 33754, 33760, 33766, 34054,
  34409, 34416, 34418, 34433, 34435, 34444, 34459, 34461, 34470, 34472, 34486,
  34488, 34511, 34513, 34521, 34524, 34532, 34537, 34540, 34556, 34559, 34568,
  34571, 34582, 34585, 34596, 34603, 34612, 34761, 34765, 34826, 34852, 34854,
  34856, 34931, 34933, 34980, 35067, 35375, 35381, 35699, 35721, 35723, 35725,
  37146, 37154, 37563, 37681, 38193, 38886, 43989, 44658, 44663, 44666, 44671,
  44673, 44699, 44704, 44707, 44712, 44714, 45041, 45049, 45123, 45125, 45189,
  46201, 46204, 46240, 46270, 46276, 46344, 46364, 46901, 46907, 46954, 47026,
  47028, 47030, 47032, 47034, 47036, 47038, 47053, 47055, 47119, 47122, 47126,
  47154, 47160, 47198, 47965, 47967, 47969, 47971, 47973, 47975, 47977, 47992,
  47994, 48060, 48064, 48092, 48098, 48136, 48445, 48754, 49080, 49086, 53316,
  56529, 56535, 63043, 63049, 63055, 63061, 63069, 63075, 63082, 63088, 63122,
  63229, 63231, 63241, 63254, 63264, 63274, 63276, 63287, 64174, 64176, 64216,
  66566, 66938, 66940, 66942, 66952, 67256, 67263, 70660, 73854, 78687, 177574,
  78691, 177578, 80392, 80454, 80456, 80458, 80503, 80529, 80533, 80535, 80537,
  80539, 80541, 80760, 80766, 80772, 80778, 80784, 80790, 81113, 81212, 81304,
  81425, 81431, 81437, 81503, 81574, 81622, 81897, 82704, 82710, 82785, 82901,
  83029, 83064, 83447, 83449, 83451, 83453, 83612, 83614, 83734, 83736, 83738,
  83740, 83742, 83744, 83959, 84004, 84006, 84223, 84225, 86106, 86755, 86757,
  86759, 88711, 88965, 92465, 93484, 93593, 93595, 93599, 93601, 93603, 93605,
  93607, 93609, 93611, 93613, 93615, 93617
]

async function loadVim (cmp: VimComponentRef) {
  globalThis.component = cmp
  const vim = await cmp.viewer.createProgressiveVim(
    'https://vimdevelopment01storage.blob.core.windows.net/split-mesh/tower/tower',
    './tower.vim',
    {
      // filter: instances,
      filterMode: 'instance',
      gzipped: true,
      loadRooms: true,
      rotation: new VIM.THREE.Vector3(270, 0, 0),
      streamGeometry: instances !== undefined,
      streamBim: true,
      noStrings: true,
      noMap: instances?.length === 1 ?? true,
      noHeader: true
    }
  )
  vim.onUpdate.subscribe(() => {
    cmp.viewer.camera.lerp(1).frame(vim.scene.getBoundingBox())
  })
  vim.build()
}
*/

globalThis.VIM = VIM
